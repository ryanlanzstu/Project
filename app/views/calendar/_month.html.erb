<p style="color: green"><%= notice %></p>

<div class="container">
  <div class="lists">
    <h2>Lists</h2>
    <div id="lists" class="sortable">
      <% if @lists.present? %>
        <% @lists.each do |list| %>
          <div class="list sticky-note" data-list-id="<%= list.id %>">
            <h3><%= list.name %></h3>
            <div class="tasks sortable" data-list-id="<%= list.id %>">
              <% list.tasks.each do |task| %>
                <div class="task" data-task-id="<%= task.id %>">
                  <%= task.name %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% else %>
        <p>No lists found.</p>
      <% end %>
    </div>
  </div>

  <div class="calendar">
    <h1><%= @date.strftime('%B %Y') %></h1>
    <div class="grid grid-cols-7">
      <div>Mon</div>
      <div>Tue</div>
      <div>Wed</div>
      <div>Thu</div>
      <div>Fri</div>
      <div>Sat</div>
      <div>Sun</div>
      <% (1..@date.end_of_month.day).each do |day| %>
        <div class="border min-h-24">
          <div class="date"><%= day %></div>
          <div id="day-<%= @date.strftime('%Y-%m') %>-<%= '%02d' % day %>" class="task-dropzone" data-controller="sortable" data-sortable-group-value="tasks" data-date="<%= @date.strftime('%Y-%m') %>-<%= '%02d' % day %>">
            <% @tasks.each do |task| %>
              <% if task.start_date.present? && task.start_date.to_date == Date.new(@date.year, @date.month, day) %>
                <div class="task" data-task-id="<%= task.id %>">
                  <%= task.name %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('turbolinks:load', function() {
    const dropzones = document.querySelectorAll('.task-dropzone');

    dropzones.forEach(dropzone => {
      new Sortable(dropzone, {
        group: 'tasks',
        animation: 150,
        onEnd: function(evt) {
          const taskId = evt.item.dataset.taskId;
          const newDate = evt.to.dataset.date;

          fetch(`/tasks/${taskId}/update_date`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ date: newDate })
          });
        }
      });
    });
  });
</script>
